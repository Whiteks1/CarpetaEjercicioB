<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uso de fetch en JS</title>
    <style>
        #usuarios {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
        }

        img {
            max-width: 100%;
            height: auto;
        }

        .ficha-user {
            width: 21%;
            border: 1px solid;
            padding: 1rem;
            border-radius: 1rem;
            box-sizing: border-box;
        }

        .edit-border {
            border: 1px solid green;
        }
    </style>
</head>

<body>
    <div class="contenedor">
        <h1>Uso de <em>fetch()</em> para acceder a datos externos</h1>
        <p>Un ejemplo de conexión a un origen de datos externo (gitHub) que devuelve un json del que vamos a usar
            algunos datos para llenar de contenido el DOM</p>
        <pre><code>
        const url = 'http://api.github.com/users'
        async function cargarDatos() {
            try {
                const res = await fetch(url)
                if (!res.ok) {
                    throw new Error('No se ha podido conectar')
                }
                const datos = await res.json()
                procesaDatos(datos, 'usuarios')
            } catch (error) {
                console.log(error)
            }
        }
        </code></pre>
        <button id="btn_data">Obtener datos externos</button>
        <div id="usuarios"></div>
    </div>
    <script>
        const url = 'http://api.github.com/users'
        const datos = []
        async function cargarDatos() {
            //iniciamos la petición de datos dentro de un control de errores
            try {
                const res = await fetch(url)
                if (!res.ok) {
                    throw new Error('No se ha podido conectar')
                }
                //accedemos a los datos en el formato que necesitamos
                datos.slice(0)
                datos.push(... await res.json())
                console.log(datos)
                //enviamos los datos a proceso
                procesaDatos(datos, 'usuarios')
            } catch (error) {
                console.log(error)
            }
        }
        function procesaDatos(datos, id_destino) {
            //acceder al contenedor
            const contenedor = document.getElementById(id_destino)
            contenedor.innerHTML = ''
            //iteramos cada objeto del array ejecutando una función sobre ellos
            datos.forEach((objeto) => creaContenido(objeto, contenedor))
        }
        function creaContenido(objeto, contenedor) {
            //creamos todos los nodos necesarios con los datos del objeto que queremos mostrar
            const caja = document.createElement('div')
            caja.className = 'ficha-user'
            const nombre = document.createElement('h4')
            nombre.textContent = objeto.login
            const iden = document.createElement('p')
            iden.textContent = 'Id usuario: ' + objeto.id
            const foto = document.createElement('img')
            foto.setAttribute('src', objeto.avatar_url)
            //editar
            const btn = document.createElement('button')
            btn.textContent = 'Editar'
            btn.onclick = () => editaNodo(caja, objeto, btn)
            caja.append(nombre, iden, foto, btn)
            //lo pasamos al DOM
            contenedor.append(caja)
        }
        function editaNodo(caja, objeto, btn) {
            console.log(caja, objeto, btn)
            btn.textContent = 'Guardar'
            const titulo = caja.querySelector('h4')
            const foto = caja.querySelector('img')
            foto.className = 'edit-border'
            foto.onclick = () => cambiaFoto(foto, objeto)
            titulo.contentEditable = true
            titulo.className = 'edit-border'
            btn.onclick = () => guardaCambios(titulo, objeto)
        }
        function guardaCambios(titulo, objeto) {
            objeto.login = titulo.textContent
            procesaDatos(datos, 'usuarios')
        }
        function cambiaFoto(foto, objeto) {
            const src = prompt('Nueva imagen')
            foto.setAttribute('src',src)
            objeto.avatar_url = src
        }
        document.getElementById('btn_data').onclick = cargarDatos
    </script>

</body>

</html>
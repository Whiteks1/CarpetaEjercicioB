<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
        integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <title>Gestor de contactos</title>
</head>
<style>
    .input-cto {
        max-height: 34px;
    }

    .panel-delete {
        width: 60%;
        position: absolute;
        left: -55%;
        transition: all .4s;
    }

    #mensajes {
        position: fixed;
        top: 0;
        z-index: 99;
        right: -340px;
        width: 340px;
        transition: all .5s;
    }
</style>

<body>
    <div class="container">
        <section class="row">
            <header class="text-bg-info p-5 mb-2">
                <h1 class="text-center">Gestión de Tabla de Contactos</h1>
            </header>
        </section>
        <section class="row">
            <div class="col-12">
                <h2 class="fs-4">Métodos disponibles en Arrays para gestionar un listado de contactos</h2>
            </div>
            <div class="col-6">
                <p>Modifica este documento para añadir más columnas al listado de contactos (mínimo 4), manteniendo la
                    misma funcionalidad de CRUD. Usa los métodos de Array para trabajar los datos, y los métodos del DOM
                    para crear los elementos que tengas que añadir al documento.
                </p>
                <p>Puedes basarte en ele ejemplo del documento que permite ordenar datos por 4 columnas que tienes en
                    Teams</p>

            </div>
            <div class="col-6">
                <h3 class="fs-5">Cambios en Storage</h3>
                <p>La función de guardar en Storage se ejecuta automáticamente cada vez que modificamos la lista de
                    contactos. El resto de funcionalidad sigue igual, al cargar la página si hay datos en el storage ya
                    los muestra en la lista de contactos, y mantenemos el botón para eliminar todo el Storage si el
                    usuario quiere.</p>
            </div>
        </section>
        <section class="row bg-info-subtle mb-5 p-3">
            <div class="col-12">
                <h2 class="text-center text-info-emphasis">Interfaz de usuario</h2>
            </div>
            <div class="col-5">
                <h3 class="fs-5 text-info-emphasis">Introduce un contacto</h3>
                <form class="bg-primary-subtle p-2 rounded">
                    <div class="form-floating mb-3">
                        <input type="text" id="in_cto" class="form-control" placeholder="Nombre">
                        <label for="in_cto">Nombre</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" id="in_apellidos" class="form-control" placeholder="Apellidos">
                        <label for="in_apellidos">Apellidos</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" id="in_poblacion" class="form-control" placeholder="Población">
                        <label for="in_poblacion">Población</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="number" id="in_edad" class="form-control" placeholder="Edad">
                        <label for="in_edad">Edad</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="number" id="in_anyo" class="form-control" placeholder="Año">
                        <label for="in_anyo">Año</label>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-light" id="btn_add_cto">Añadir</button>
                    </div>
                </form>

                <div>
                    <div class="card mt-3">
                        <div class="card-header">
                            Uso de Storage
                        </div>
                        <div class="card-body">
                            <h4 class="card-title">Guardar y Borrar en el Storage</h4>
                            <p class="card-text"> El array de contactos es covertido a un <em>string</em> para ser
                                almacenado en los datos del navegador.</p>
                            <div class="d-flex justify-content-end gap-2">
                                <button class="btn btn-danger" id="btn_lb">Borrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-7">
                <h3 class="fs-5 text-info-emphasis">Listado de contactos</h3>
                <div class="gr-contacts">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th data-campo="0" data-orden="-1">Nombre</th>
                                <th data-campo="1" data-orden="-1">Apellidos</th>
                                <th data-campo="2" data-orden="-1">Población</th>
                                <th data-campo="3" data-orden="-1">Edad</th>
                                <th data-campo="4" data-orden="-1">Año</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="lista_ctos"></tbody>
                    </table>
                </div>
            </div>
        </section>
        <div class="alert alert-success" role="alert" id="mensajes">
            <h4 class="alert-heading">Contacto Añadido</h4>
            <p>El contacto se ha añadido a tu lista de Contactos correctamente.</p>
            <hr>
            <p class="mb-0">JavaScript y BootStrap alegran tu vida.</p>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
        crossorigin="anonymous"></script>
    <script src="biblioteca.js"></script>
    <script id="propio">
        const agenda = [];

        //Referencias a los inputs
        const in_nombre = document.querySelector('#in_cto');
        const in_apellidos = document.querySelector('#in_apellidos');
        const in_poblacion = document.querySelector('#in_poblacion');
        const in_edad = document.querySelector('#in_edad');
        const in_anyo = document.querySelector('#in_anyo');
        //botones
        const btn_add_cto = document.querySelector('#btn_add_cto');
        const btn_local_borra = document.querySelector('#btn_lb');
        const lista_ctos = document.querySelector('#lista_ctos');


        //variables del modo edición
        let isEditMode = false;
        let editIndex = null;
        //FUNCIONES

        function addContacto() {
            if (isEditMode) {
                muestraMensaje(5, 'warning');
                return;
            }

            //leer los valores
            const nomb = validaTxt(in_nombre.value);
            const apll = validaTxt(in_apellidos.value);
            const pobl = validaTxt(in_poblacion.value);
            const edad = validaNumero(in_edad.value);
            const anyo = validaNumero(in_anyo.value);
            //Validar
            if (!nomb || !apll || !pobl || !edad || !anyo) {
                muestraMensaje(2, 'danger');
                return;

            }
            //contacto como array 2D
            const contacto = [nomb, apll, pobl, edad, anyo]

            //guardarl en la agenda y actualizarlo
            agenda.push(contacto);
            creaListado();
            muestraMensaje(1, 'success')

            //Limpiar el formulario
            limpiaFormulario();
        }

        function limpiaFormulario() {
            in_nombre.value = '';
            in_apellidos.value = '';
            in_poblacion.value = '';
            in_edad.value = '';
            in_anyo.value = '';
            in_nombre.focus();

        }


        function creaListado() {
            lista_ctos.innerHTML = '';//Vaciar el tbody
            //recorrer el array
            agenda.forEach((contacto, indice) => {
                const fila = creaNodo('tr', '', '');

                //crea 5 columnas de datos
                for (let i = 0; i < 5; i++) {
                    const celda = creaNodo('td', '', contacto[i]);
                    fila.appendChild(celda);

                }

                //Acciones Editar
                const celdaAcciones = creaNodo('td', '', '');
                const btn_edit = creaNodo('button', 'btn btn-primary btn-sm', 'Editar');
                btn_edit.onclick = () => { editCto(indice); };

                //Borrar
                const btn_del = creaNodo('button', 'btn btn-danger btn-sm', 'Eliminar');
                btn_del.onclick = () => delCto(indice);

                celdaAcciones.append(btn_edit, btn_del);
                fila.appendChild(celdaAcciones);

                lista_ctos.appendChild(fila);
            });


            guardaLocal();

        }



        function editCto(posicion) {
            if (isEditMode) {
                muestraMensaje(5, 'warning');
                return;
            }
            isEditMode = true;
            editIndex = posicion;

            const contacto = agenda[posicion];
            //rellenar el formulario con los datos
            in_nombre.value = contacto[0];
            in_apellidos.value = contacto[1];
            in_poblacion.value = contacto[2];
            in_edad.value = contacto[3];
            in_anyo.value = contacto[4];

            //Boton guardar cambios
            btn_add_cto.textContent = "Guardar Cambios"
            btn_add_cto.onclick = actualizaCto;

        }

        function actualizaCto() {
            if (editIndex === null) return;

            const nomb = validaTxt(in_nombre.value);
            const apll = validaTxt(in_apellidos.value);
            const pobl = validaTxt(in_poblacion.value);
            const edad = validaNumero(in_edad.value);
            const anyo = validaNumero(in_anyo.value);

            if (!nomb || !apll || !pobl || !edad || !anyo) {
                muestraMensaje(2, 'danger');
                return;

            }
            agenda[editIndex] = [nomb, apll, pobl, edad, anyo];
            creaListado();
            muestraMensaje(3, 'success');


            //Reset modo edición
            isEditMode = false;
            editIndex = null;
            btn_add_cto.textContent = 'Añadir'
            btn_add_cto.onclick = addContacto;
            limpiaFormulario();


        }
        //Eliminar un contacto
        function delCto(posicion) {
            if (isEditMode) {
                muestraMensaje(5, 'warning');
                return;
            }

            const confirmar = confirm('¿Seguro que quieres eliminar este contacto?');
            if (!confirmar) return;

            agenda.splice(posicion, 1);
            creaListado();
            muestraMensaje(4, 'danger');
        }
        //Ordenar la tabla
        function ordenaTabla() {
            const campo = parseInt(this.dataset.campo);
            let orden = parseInt(this.dataset.orden);

            //se invierte el orden en cada clic
            orden = orden * -1;
            this.dataset.orden = orden

            agenda.sort(function (a, b) {
                if (a[campo] == b[campo]) {
                    return 0;
                } else {
                    return (a[campo] < b[campo] ? -1 : 1) * orden;
                }

            });
            creaListado();
        }

        //Asignar Eventos a los theads
        const cabeceras = document.querySelectorAll('thead th[data-campo]');
        cabeceras.forEach(th => {
            th.onclick = ordenaTabla
        });
        //validación del texto
        function validaTxt(texto) {
            let txt_limpio = texto.trim()
            while (txt_limpio.indexOf('  ') != -1) {
                txt_limpio = txt_limpio.replaceAll('  ', ' ');
            }
            if (txt_limpio.length < 3) {
                return false;
            }
            return txt_limpio;
        }
        //validación de numeros(año, edad)
        function validaNumero(valor) {
            const numero = parseInt(valor);
            if (isNaN(numero)) return false;
            if (numero <= 0) return false
            return numero;
        }


        function muestraMensaje(contenido, formato) {
            const mensaje = document.querySelector('#mensajes');
            const titulo = mensaje.querySelector('h4');
            const parrafo = mensaje.querySelector('p');
            let tit_txt = '';
            let par_txt = '';
            //muestra mensaje
            mensaje.style.right = 0;
            //configuramos mensaje
            switch (contenido) {
                case 1:
                    tit_txt = 'Contacto Añadido';
                    par_txt = 'El contacto se ha añadido a tu lista de contactos correctamente.'
                    break;
                case 2:
                    tit_txt = 'Dato no Válido';
                    par_txt = 'Los datos introducidos no son correctos. Debes escribir al menos 3 caracteres que no sean espacios.'
                    break;
                case 3:
                    tit_txt = 'Contacto Actualizado';
                    par_txt = 'El contacto se ha modificado en tu agenda correctamente.'
                    break;
                case 4:
                    tit_txt = 'Contacto Eliminado';
                    par_txt = 'El contacto se ha eliminado de tu agenda correctamente.'
                    break;
                case 5:
                    tit_txt = 'Modo Edición Activado';
                    par_txt = 'No puedes realizar otras acciones hasta que no termines la tarea actual.'
                    break;
                case 6:
                    tit_txt = 'Datos Guardadados';
                    par_txt = 'El listado se almacenado en el localStorage de la aplicación.'
                    break;
                case 7:
                    tit_txt = 'Datos Eliminados';
                    par_txt = 'El listado se ha borrado correctamente del localStorage de la aplicación.'
                    break;
                case 8:
                    tit_txt = 'Datos Recuperados';
                    par_txt = 'El listado que aparece en pantalla son los datos del Storage.'
                    break;
                case 9:
                    tit_txt = 'No hay datos a recuperar';
                    par_txt = 'El Storage está vacío y no hay datos que mostrar en él.'
                    break;
                default:
                    tit_txt = 'Cuadro de Mensajes';
                    par_txt = 'En este espacio se muestran los mensajes de la aplicación';
                    break;
            }
            mensaje.className = 'alert';
            mensaje.classList.add('alert-' + formato);
            titulo.textContent = tit_txt;
            parrafo.textContent = par_txt;
            //oculta el mensaje
            setTimeout(escondeMensaje, 3000)
        }
        function escondeMensaje() {
            document.querySelector('#mensajes').style.right = '-340px';
        }
        //STORAGE
        function guardaLocal() {
            //paso el array a tipo string
            let respaldo = JSON.stringify(agenda);
            //almaceno ese string en localStorage con la etiqueta agenda
            localStorage.setItem('agenda', respaldo);

        }
        function recuperaLocal() {
            if (isEditMode) {
                muestraMensaje(5, 'warning');
                return;
            }
            //leo los datos del Storage
            let respaldo = localStorage.getItem('agenda');
            //los convierto en objeto
            let agenda_respaldo = JSON.parse(respaldo);
            //añado el array de resplado a la agenda si existe el respaldo y hay datos en él
            if (agenda_respaldo && agenda_respaldo.length > 0) {
                //borro lo que pueda haber en la agenda previamente
                agenda.splice(0);
                agenda.push(...agenda_respaldo)
                muestraMensaje(8, 'success');
                creaListado()
            } else {
                muestraMensaje(9, 'warning');
            }
        }
        function borraLocal() {
            if (isEditMode) {
                muestraMensaje(5, 'warning');
                return;
            }
            localStorage.removeItem('agenda');
            agenda.splice(0);
            creaListado();
            muestraMensaje(7, 'danger');
        }
        //ASIGNACIONES
        btn_add_cto.onclick = addContacto;
        btn_local_borra.onclick = borraLocal;


        //INICIO
        window.onload = function () {
            // Vaciar la agenda antes de cargar
            agenda.splice(0);

            const respaldo = localStorage.getItem('agenda');

            if (respaldo) {
                const datos = JSON.parse(respaldo);

                // Solo cargamos si es un array y tiene datos
                if (Array.isArray(datos) && datos.length > 0) {
                    agenda.push(...datos);
                } else {
                    agenda.push(
                        ['Leticia', 'García', 'Valencia', 30, 1995],
                        ['Luz', 'Pérez', 'Madrid', 25, 2000],
                        ['Jorge', 'López', 'Sevilla', 40, 1985],
                        ['Javier', 'Martín', 'Bilbao', 35, 1990],
                        ['Pilar', 'Sánchez', 'Barcelona', 28, 1997]
                    );
                    guardaLocal();
                }
                creaListado();
            };
        }


    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
        integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <title>Gestor de contactos</title>
</head>
<style>
    .input-cto {
        max-height: 34px;
    }

    .panel-delete {
        width: 60%;
        position: absolute;
        left: -55%;
        transition: all .4s;
    }

    #mensajes {
        position: fixed;
        top: 0;
        z-index: 99;
        right: -340px;
        width: 340px;
        transition: all .5s;
    }
</style>

<body>
    <div class="container">
        <section class="row">
            <header class="text-bg-info p-5 mb-2">
                <h1 class="text-center">Otro gestor de contactos</h1>
            </header>
        </section>
        <section class="row">
            <div class="col-12">
                <h2 class="fs-4">Gestión de datos con JavaScript</h2>
            </div>
            <div class="col-6">
                <p>En este ejercicio vamos a realizar una práctica de <strong>CRUD</strong> <em>(Create, Read,
                        Update,Delete)</em> usando JavaScript <em>Vanilla</em> (puro, sin librerías ni Frameworks
                    adicionales). El formato del documento lo aplicaremos con <strong>BootStrap</strong> para el
                    <em>CSS</em>.
                </p>
                <h3 class="fs-5">Lógica de la Aplicación</h3>
                <p>Los datos de la agenda se van a almacenar en un <strong>array</strong> definido en una constante. La
                    interfaz va a permitir añadir, visualizar, editar y eliminar datos a esa matriz.</p>
                <p>Para simplificar el proceso las 4 operaciones de <em>CRUD</em> se encargan de modificar los datos en
                    el listado, y una vez realizada la operación se llama a una función que recrea el DOM a partir de
                    los datos actuales del array. De esta forma nos aseguramos de que la pantalla muestra siempre el
                    contenido actualizado del array.</p>
            </div>
            <div class="col-6">
                <h3 class="fs-5">Información al usuario</h3>
                <p>Cada función muestra un mensaje para el usuario con el resultado de la operación. Para eso se usa una
                    función parametrizada que indica el contenido del mensaje a mostrar y su formato sobre un elemento
                    del DOM.</p>
                <h3 class="fs-5">Uso de localStorage para hacer respaldo de datos</h3>
                <p>Para conseguir que los datos almacenados persistan después de cerrar el navegador usamos el
                    almacenamiento de <em>localStorage</em> permitiendo al usuario guardar, recuperar y borrar los datos
                    almacenados en él.</p>
            </div>
        </section>
        <section class="row bg-info-subtle mb-5 p-3">
            <div class="col-12">
                <h2 class="text-center text-info-emphasis">Interfaz de usuario</h2>
            </div>
            <div class="col-5">
                <h3 class="fs-5 text-info-emphasis">Introduce un contacto</h3>
                <form class="bg-primary-subtle p-2 rounded">
                    <div class="form-floating mb-3">
                        <input type="text" id="in_cto" class="form-control" placeholder="Nombre">
                        <label for="in_cto">Nombre del contacto</label>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-light" id="btn_add_cto">Añadir</button>
                    </div>
                </form>
                <div>
                    <div class="card mt-3">
                        <div class="card-header">
                            Uso de Storage
                        </div>
                        <div class="card-body">
                            <h4 class="card-title">Guardar y Borrar en el Storage</h4>
                            <p class="card-text"> El array de contactos es covertido a un <em>string</em> para ser
                                almacenado en los datos del navegador.</p>
                            <div class="d-flex justify-content-end gap-2">
                                <button class="btn btn-success" id="btn_ls">Guardar</button>
                                <button class="btn btn-info" id="btn_lr">Recuperar</button>
                                <button class="btn btn-danger" id="btn_lb">Borrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-7">
                <h3 class="fs-5 text-info-emphasis">Listado de contactos</h3>
                <div class="gr-contacts">
                    <ul class="list-group" id="lista_ctos"></ul>
                </div>
            </div>
        </section>
        <section class="row">
            <div class="col-12">
                <h2>Script de la aplicación</h2>
                <pre class="overflow-auto h-25 border border-3">
                    <code id="copia"></code>
                </pre>
            </div>
        </section>
        <div class="alert alert-success" role="alert" id="mensajes">
            <h4 class="alert-heading">Contacto Añadido</h4>
            <p>El contacto se ha añadido a tu lista de Contactos correctamente.</p>
            <hr>
            <p class="mb-0">JavaScript y BootStrap alegran tu vida.</p>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
        crossorigin="anonymous"></script>
    <script id="propio">
        const agenda = [];
        const in_cto = document.querySelector('#in_cto');
        const btn_add_cto = document.querySelector('#btn_add_cto');
        const btn_local_save = document.querySelector('#btn_ls');
        const btn_local_read = document.querySelector('#btn_lr');
        const btn_local_borra = document.querySelector('#btn_lb');
        const lista_ctos = document.querySelector('#lista_ctos');
        let isEditMode = false;
        //FUNCIONES

        function addContacto() {
            if (isEditMode) {
                muestraMensaje(5, 'warning');
                return;
            }
            let nom_cto = in_cto.value;
            let validado = validaTxt(nom_cto);
            if (validado) {
                agenda.push(validado);
                creaListado();
                muestraMensaje(1, 'success');
            } else {
                muestraMensaje(2, 'danger');
            }
            in_cto.value = '';
            in_cto.focus();
        }
        function creaListado() {
            lista_ctos.innerHTML = '';
            for (const [indice, contacto] of agenda.entries()) {
                //crear elementos dinámicos
                let elemento = document.createElement('li');
                elemento.className = 'list-group-item d-flex gap-3 align-items-start overflow-hidden';
                let nom_cto = document.createElement('span');
                nom_cto.textContent = contacto;
                nom_cto.className = 'w-100 p-1 input-cto';
                let btn_edit = document.createElement('button')
                btn_edit.innerHTML = '&#128393;';
                btn_edit.className = 'btn btn-primary';
                btn_edit.onclick = function () { editCto(btn_edit, indice) };
                let btn_del = document.createElement('button')
                btn_del.innerHTML = '&#10008;';
                btn_del.className = 'btn btn-danger';
                btn_del.onclick = function () { delCto(btn_del, indice) };
                elemento.append(nom_cto, btn_edit, btn_del);
                lista_ctos.append(elemento);
            }

        }
        function editCto(boton, posicion) {
            if (isEditMode) {
                muestraMensaje(5, 'warning');
                return;
            }
            isEditMode = true;
            //accedemos al nodo de texto y lo configuramos
            let nodo_texto = boton.previousElementSibling;
            nodo_texto.classList.add('border', 'border-1', 'border-primary');
            nodo_texto.setAttribute('contenteditable', true);
            window.getSelection().selectAllChildren(nodo_texto);
            //controlar teclas pulsadas
            nodo_texto.addEventListener('keydown', function (evento) { controlKeys(evento, nodo_texto, posicion) })
            //cambiamos formato boton editar
            boton.classList.add('text-bg-success');
            boton.innerHTML = '&#10003;';
            boton.onclick = function () { actualizaCto(nodo_texto, posicion) }
        }
        function actualizaCto(nodo, posicion) {
            let validado = validaTxt(nodo.textContent);
            if (validado) {
                agenda[posicion] = validado;
                creaListado();
                muestraMensaje(3, 'success');
                isEditMode = false;
            } else {
                nodo.classList.add('border', 'border-1', 'border-danger');
                nodo.textContent = ''
                nodo.focus();
            }
        }
        function delCto(nodo, quien) {
            if (isEditMode) {
                muestraMensaje(5, 'warning');
                return;
            }
            isEditMode = true;
            let contenedor = nodo.parentNode;
            //si ya existe el panel lo elimino antes de volver a crearlo
            if (contenedor.childNodes[0].nodeName == 'DIV') {
                contenedor.childNodes[0].remove();
            }
            //creo el panel con sus botones
            let caja = document.createElement('div');
            caja.className = 'panel-delete';
            let btn_conf = document.createElement('button');
            btn_conf.className = 'btn btn-danger me-3';
            btn_conf.textContent = 'Confirmar';
            btn_conf.onclick = function () {
                agenda.splice(quien, 1);
                creaListado();
                muestraMensaje(4, 'danger');
                isEditMode = false;
            }
            let btn_canc = document.createElement('button');
            btn_canc.className = 'btn btn-primary';
            btn_canc.textContent = 'Cancelar';
            btn_canc.onclick = function () {
                caja.style.left = '-55%';
                isEditMode = false;
            }
            caja.append(btn_conf, btn_canc);
            contenedor.prepend(caja);
            //demoro la aparición del elemento para que pueda ser de forma animada
            setTimeout(function () { caja.style.left = '1rem' }, 100);
        }
        function controlKeys(evento, nodo, posicion) {
            if (evento.key == 'Enter') {
                actualizaCto(nodo, posicion);
            }
            if (evento.key == 'Escape') {
                creaListado();
                isEditMode = false;
            }
        }
        //validación del texto
        function validaTxt(texto) {
            let txt_limpio = texto.trim()
            while (txt_limpio.indexOf('  ') != -1) {
                txt_limpio = txt_limpio.replaceAll('  ', ' ');
            }
            if (txt_limpio.length < 3) {
                return false;
            }
            return txt_limpio;
        }
        function muestraMensaje(contenido, formato) {
            const mensaje = document.querySelector('#mensajes');
            const titulo = mensaje.querySelector('h4');
            const parrafo = mensaje.querySelector('p');
            let tit_txt = '';
            let par_txt = '';
            //muestra mensaje
            mensaje.style.right = 0;
            //configuramos mensaje
            switch (contenido) {
                case 1:
                    tit_txt = 'Contacto Añadido';
                    par_txt = 'El contacto se ha añadido a tu lista de contactos correctamente.'
                    break;
                case 2:
                    tit_txt = 'Dato no Válido';
                    par_txt = 'Los datos introducidos no son correctos. Debes escribir al menos 3 caracteres que no sean espacios.'
                    break;
                case 3:
                    tit_txt = 'Contacto Actualizado';
                    par_txt = 'El contacto se ha modificado en tu agenda correctamente.'
                    break;
                case 4:
                    tit_txt = 'Contacto Eliminado';
                    par_txt = 'El contacto se ha eliminado de tu agenda correctamente.'
                    break;
                case 5:
                    tit_txt = 'Modo Edición Activado';
                    par_txt = 'No puedes realizar otras acciones hasta que no termines la tarea actual.'
                    break;
                case 6:
                    tit_txt = 'Datos Guardadados';
                    par_txt = 'El listado se almacenado en el localStorage de la aplicación.'
                    break;
                case 7:
                    tit_txt = 'Datos Eliminados';
                    par_txt = 'El listado se ha borrado correctamente del localStorage de la aplicación.'
                    break;
                case 8:
                    tit_txt = 'Datos Recuperados';
                    par_txt = 'El listado que aparece en pantalla son los datos del Storage.'
                    break;
                case 9:
                    tit_txt = 'No hay datos a recuperar';
                    par_txt = 'El Storage está vacío y no hay datos que mostrar en él.'
                    break;
                default:
                    tit_txt = 'Cuadro de Mensajes';
                    par_txt = 'En este espacio se muestran los mensajes de la aplicación';
                    break;
            }
            mensaje.className = 'alert';
            mensaje.classList.add('alert-' + formato);
            titulo.textContent = tit_txt;
            parrafo.textContent = par_txt;
            //oculta el mensaje
            setTimeout(escondeMensaje, 3000)
        }
        function escondeMensaje() {
            document.querySelector('#mensajes').style.right = '-340px';
        }
        //STORAGE
        function guardaLocal() {
            if (isEditMode) {
                muestraMensaje(5, 'warning');
                return;
            }
            //paso el array a tipo string
            let respaldo = JSON.stringify(agenda);
            //almaceno ese string en localStorage con la etiqueta agenda
            localStorage.setItem('agenda', respaldo);
            muestraMensaje(6, 'success');
        }
        function recuperaLocal() {
            if (isEditMode) {
                muestraMensaje(5, 'warning');
                return;
            }
            //leo los datos del Storage
            let respaldo = localStorage.getItem('agenda');
            //los convierto en objeto
            let agenda_respaldo = JSON.parse(respaldo);
            //añado el array de resplado a la agenda si existe el respaldo y hay datos en él
            if (agenda_respaldo && agenda_respaldo.length > 0) {
                //borro lo que pueda haber en la agenda previamente
                agenda.splice(0);
                agenda.push(...agenda_respaldo)
                //generamos el DOM
                muestraMensaje(8, 'success');
                creaListado()
            } else {
                muestraMensaje(9, 'warning');
            }
        }
        function borraLocal() {
            if (isEditMode) {
                muestraMensaje(5, 'warning');
                return;
            }
            localStorage.clear();
            muestraMensaje(7, 'danger');
        }
        //ASIGNACIONES
        btn_add_cto.onclick = addContacto;
        btn_local_save.onclick = guardaLocal;
        btn_local_read.onclick = recuperaLocal;
        btn_local_borra.onclick = borraLocal;
        //INICIO
        window.onload = function () {
            //copio el script en el DOM
            document.querySelector('#copia').textContent = document.querySelector('#propio').textContent;
            //si hay datos en el Storage los uso para empezar, y si no empiezo con una muestra
            agenda.splice(0);
            if (localStorage.getItem('agenda')) {
                agenda.push(...JSON.parse(localStorage.getItem('agenda')));
            } else {
                agenda.push('Leticia', 'Luz', 'Jorge', 'Javier', 'Pilar');
            }
            creaListado()
        };
    </script>
</body>

</html>
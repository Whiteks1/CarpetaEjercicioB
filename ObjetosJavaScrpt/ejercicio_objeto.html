<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Gestor de Paquetería</title>
        <style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        margin: 0;
        padding: 40px;
        
    }

    .contenedor {
        max-width: 1200px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h1, h2 {
        text-align: center;
    }

    form {
        background: #fafafa;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 1px solid #ddd;
        box-shadow: 0px 4px 12px rgba(0,0,0,0.8);
    }

    label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
    }

    input, select {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
    }

    button {
        margin-top: 15px;
        width: 100%;
        padding: 10px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
    }

    button:hover {
        background-color: #2980b9;
    }

    #repartidor {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    #repartidor form {
        flex: 1 1 300px;    }   

    #listadoPaquetes {
        margin-top: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
    }

    .paquete-card .info-paquete {
    width: 100%;

}  
    .paquete-card {
    position: relative;
    background: #ffffff;
    padding: 18px 20px;
    border-left: 6px solid #3498db;
    border-radius: 5px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;    /*canvas arriba y texto abajo.*/ 
    align-items: center;         
    gap: 12px;
    }

    .paquete-card h3 {
    font-family: "Segoe UI", Roboto, sans-serif;
    font-size: 20px;
    font-weight: 500;
    color: #000000;
    margin-bottom: 10px;
    }

    .paquete-card p{
        margin: 5px 0;
    }

    .paquete-card p label {
    font-weight: 600;
    color: #2c3e50;

    }

    .paquete-dibujo {
    width: 100%;
    max-width: 250px;               
    display: flex;
    justify-content: center;
    align-items: center;
    border: 2px solid #ccc;
    border-radius: 10px;
    background: #f0f0f0;
    box-sizing: border-box;
    padding: 10px;
    }

    .btn-eliminar {
        position: absolute;
        top: 8px;
        right: 10px;
        font-size: 16px;
        background: #fff7f7;
        color:  #c0392b;
        border: none;
        border-radius: 6px;
        width: 25px;
        height: 25px;
        cursor: pointer;
        line-height: 1;
    
    }

    .btn-editar {
    position: absolute;
    top: 8px;
    right: 40px;
    font-size: 16px;
    background: #f5fff7;
    color: #27ae60;
    border: none;
    border-radius: 6px;
    width: 25px;
    height: 25px;
    cursor: pointer;
    line-height: 1;
}


</style>

    </head>
    <body>
        <div class="contenedor">
            <h1>Gestión de Datos Usando Objetos</h1>
            <p>El ejercicio consiste en una aplicación que gestione un sistema
                de reparto de paquetes con las siguientes caracteristícas</p>
            <ul>
                <li>Un objeto repartidor</li>
                <li>Un objeto paquete</li>
                <li>Interfaz para crear repartidores</li>
                <li>Los repartidores se almacenan en un Array</li>
                <li>Interfaz para crear paquetes</li>
                <li>Repartidor de cada paquete creado se selecciona desde un
                    elemento select</li>
                <li>Cada objeto <code>paquete</code> se guarda en un objeto
                    principal, llamado <code>Reparto</code></li>
                <li>Representación visual de cada paquete creado con su
                    información</li>
            </ul>

            <div id="repartidor">
                <form id="formRepartidor">
                    <h2>Crear Repartidor</h2>
                    <label for="nombreRepartidor">Nombre:</label>
                    <input type="text" id="nombreRepartidor" required>

                    <label for="vehiculoRepartidor">Vehículo: Matrícula</label>
                    <input type="text" id="vehiculoRepartidor" required>

                    <label for="experienciaRepartidor">Experiencia
                        (años):</label>
                    <input type="number" id="experienciaRepartidor" min="0"
                        value="0" required>

                    <button type="submit">Crear Repartidor</button>
                </form>

                <form id="formPaquete">
                    <h2>Crear Paquete</h2>

                    <label for="pesoPaquete">Peso (kg)</label>
                    <input type="number" id="pesoPaquete" min="0.1" step="0.1"
                        required>

                    <label for="largoPaquete">Largo (cm)</label>
                    <input type="number" id="largoPaquete" min="1" required>

                    <label for="anchoPaquete">Ancho (cm)</label>
                    <input type="number" id="anchoPaquete" min="1" required>

                    <label for="altoPaquete">Alto (cm)</label>
                    <input type="number" id="altoPaquete" min="1" required>

                    <label for="destinoPaquete">Destino</label>
                    <select id="destinoPaquete" required>
                        <option value disabled selected>Seleccione
                            destino</option>
                        <option value="Nacional">Nacional</option>
                        <option value="Internacional">Internacional</option>
                    </select>

                    <label for="colorPaquete">Color</label>
                    <select id="colorPaquete" required>
                        <option value disabled selected>Seleccione un
                            color</option>
                        <option value="red">Rojo</option>
                        <option value="yellow">Amarillo</option>
                        <option value="green">Verde</option>
                        <option value="white">Blanco</option>
                        <option value="black">Negro</option>
                    </select>

                    <label for="repartidorPaquete">Repartidor</label>
                    <select id="repartidorPaquete" required>
                        <option value disabled selected>Seleccione un
                            repartidor</option>
                    </select>

                    <button id="btnPaquete" type="submit">Crear Paquete</button>
                </form>
            </div>

            <h2>Paquetes Creados</h2>
            <button id="btnBorrarDatos">Borrar datos guardados</button>
            <div id="listadoPaquetes"></div>
        </div>

        <script>
        // Referencias al DOM
        const formRepartidor   = document.getElementById('formRepartidor');
        const formPaquete      = document.getElementById('formPaquete'); 
        const selectRepartidor = document.getElementById('repartidorPaquete');
        const listadoPaquetes  = document.getElementById('listadoPaquetes');
        const btnPaquete       = document.getElementById('btnPaquete');
        const btnBorrarDatos   = document.getElementById('btnBorrarDatos');

    
        // Array para almacenar los repartidores
        let repartidores = [];

        //Cada objeto paquete se guarda en un objeto principal Reparto
        let Reparto = {
            paquetes: [],
            agregarPaquete: function (paquete) {
                this.paquetes.push(paquete);
            }
        };

         //Variables modo edición
        let modoEdicion = false;
        let paqueteEnEdicion = null;

        // Constructor Repartidor
        function Repartidor(nombre, vehiculo, experiencia) {
            this.nombre = nombre;
            this.vehiculo = vehiculo;
            this.experiencia = experiencia;
        }

        // Constructor Paquete
        function Paquete(id, peso, largo, ancho, alto, destino, color, repartidor) {
            this.id = id;
            this.peso = peso;
            this.largo = largo;
            this.ancho = ancho;
            this.alto = alto;
            this.destino = destino;
            this.color = color;
            this.repartidor = repartidor;
            // Métodos del paquete
            this.superficie = function () {
                return this.ancho * this.largo;
            };
            this.volumen = function () {
                return this.superficie() * this.alto;
            };
        }

        //
        function EnModoEdición(paquete) {
            modoEdicion = true;
            paqueteEnEdicion = paquete;
            
            //cargar datos en el formulario
            document.getElementById('pesoPaquete').value = paquete.peso;
            document.getElementById('largoPaquete').value = paquete.largo;
            document.getElementById('anchoPaquete').value = paquete.ancho;
            document.getElementById('altoPaquete').value = paquete.alto;
            document.getElementById('destinoPaquete').value = paquete.destino;
            document.getElementById('colorPaquete').value = paquete.color;

            //seleccionar el repartidor 
            const indexRep = repartidores.indexOf(paquete.repartidor);
            if (indexRep !== -1) {
                selectRepartidor.value = indexRep;
                
            }else {
                selectRepartidor.selectedIndex = 0
            }
            //cambia el texto del boton del formulario

            btnPaquete.textContent = 'Guardar cambios'

            // Deshabilitar inputs y selects del formulario de repartidor
            const camposRepartidor = formRepartidor.querySelectorAll('input, select');
            camposRepartidor.forEach(campo => {
                campo.disabled = true;
            });

            alert (" Estas en Modo Edición");
            return;
            
        }

        function salirModoEdicion() {
            modoEdicion = false;
            paqueteEnEdicion = null;
            btnPaquete.textContent = 'Crear Paquete'

            //Rehabilitar inputs y selects del formulario Repartidor

            const camposRepartidor = formRepartidor.querySelectorAll('input, select');
            camposRepartidor.forEach(campo => {
                campo.disabled = false;
            });
            
        }

        //localStorage

        function guardarDatos() {
            //Convertir arrays a texto
            const textoRepartidores = JSON.stringify(repartidores);
            const textoPaquetes     = JSON.stringify(Reparto.paquetes);

            //Guarda en el storage
            localStorage.setItem('repartidores', textoRepartidores);
            localStorage.setItem('paquetes', textoPaquetes);
            
        }

        //Cargar desde el localStorage
        function cargamosDatos() {
            const textoRepartidores = localStorage.getItem('repartidores');
            const textoPaquetes     = localStorage.getItem('paquetes');

            //si hay reapartidores guardados, los cargamos
            if (textoRepartidores) {
                const datosRep = JSON.parse(textoRepartidores);
                repartidores   = datosRep.map(r => new Repartidor(r.nombre, r.vehiculo, r.experiencia ));
                
            }

            //si hay paquetes guardados, lo cargamos
            if (textoPaquetes) {
                const datosPaq   = JSON.parse(textoPaquetes);
                Reparto.paquetes = datosPaq.map(p=> {
                //Busca el repartidor por nombre
                const repEncontrado = repartidores.find(r => r.nombre === p.repartidor.nombre)|| repartidores[0] || null
                
                return new Paquete (
                    p.id,
                    p.peso,
                    p.largo,
                    p.ancho,
                    p.alto,
                    p.destino,
                    p.color,
                    repEncontrado
                );
            });

        }
            //actualiza Interfaz
            actualizarSelectRepartidores();
            pintarPaquetes()
        }

        function borrarDatos() {
            if (modoEdicion) {
                alert('Modo Edición: Guarda primero los cambios');
                return;                
            }

            //Confirmación antes de borrar
            const seguro = confirm("¿Seguro que quieres borrar todos los datos guardados?");
            if (!seguro) {
                return; // Cancelado por el usuario, no hacemos nada
            }
            //Borramos el localStorage
            localStorage.removeItem('repartidores');
            localStorage.removeItem('paquetes');

            //Limpia los arrays
            repartidores     = [];
            Reparto.paquetes = [];

            actualizarSelectRepartidores();
            pintarPaquetes();

            alert('Datos Borrados');

            btnBorrarDatos.addEventListener('click', borrarDatos);

            
        }

        // Recorre el array de repartidores y actualiza el select
        function actualizarSelectRepartidores() {
            selectRepartidor.innerHTML = '';
            const opcionInicial = document.createElement('option');
            opcionInicial.value = '';
            opcionInicial.disabled = true;
            opcionInicial.selected = true;
            opcionInicial.textContent = 'Seleccione un repartidor';
            selectRepartidor.append(opcionInicial);

            //rellenar con los repartidores del array
            repartidores.forEach((repartidor, index) => {
                const option = document.createElement('option');
                option.value = index; // índice del repartidor en el array
                option.textContent = `${repartidor.nombre} (${repartidor.vehiculo})`;
                selectRepartidor.append(option);
            });
        }


       //pinta los paquetes en el listado
        function pintarPaquetes() {
        listadoPaquetes.innerHTML = ''; 

        if (Reparto.paquetes.length === 0) {
            listadoPaquetes.innerHTML = '<p>No hay paquetes creados.</p>';
            return;
        }

         // Recorre los paquetes y crea una tarjeta para cada uno    
            Reparto.paquetes.forEach(function (paquete) {
            // Crear tarjeta del paquete
            const card = document.createElement('div');
            card.className = 'paquete-card';

            // Columna con información del paquete
            const info = document.createElement('div');

            const titulo = document.createElement('h3');
            titulo.textContent = `Paquete #${paquete.id}`;

            const peso = document.createElement('p');   
            peso.innerHTML = `<span class="label">Peso:</span> ${paquete.peso} kg`;


            const dimensiones = document.createElement('p');
            dimensiones.textContent =
                `Dimensiones: ${paquete.largo} x ${paquete.ancho} x ${paquete.alto} cm (Sup: ${paquete.superficie()} cm²)`;

            const color = document.createElement('p');
            color.textContent = `Color: ${paquete.color}`;

            const destino = document.createElement('p');
            destino.textContent = `Destino: ${paquete.destino}`;    

        // Información del repartidor
            const repartidorInfo = document.createElement('p');
            repartidorInfo.textContent =
                `Repartidor: ${paquete.repartidor.nombre} (${paquete.repartidor.vehiculo})`;

            // Añadir todos los elementos al contenedor info
            info.append(titulo);
            info.append(peso);
            info.append(dimensiones);
            info.append(color);
            info.append(destino);
            info.append(repartidorInfo);

            // Columna con dibujo del paquete
            const dibujo = document.createElement('div');
            dibujo.id = 'dibujo' + paquete.id;
            dibujo.className = 'paquete-dibujo';

            // Añadir columnas a la card
            card.append(info);
            card.append(dibujo);

            //Botones Eliminar/Editar
            
            //Eliminar
            const btnEliminar  = document.createElement('button');
            btnEliminar.textContent = 'X';
            btnEliminar.className = 'btn-eliminar';

            btnEliminar.onclick = function () {

                if (modoEdicion) {
                    alert('Modo Edición: No puedes eliminar, guarda primero');
                    return;   
                }
                //confirmación antes de eliminar
                const confirmar = confirm(`¿Seguro que quieres eliminar el paquete #${paquete.id}?`);
                if (!confirmar) {
                    return;  
                }
                // Eliminar paquete del array
                Reparto.paquetes = Reparto.paquetes.filter(p => p.id !== paquete.id);
                // Volver a pintar los paquetes
                pintarPaquetes();
            };
            card.append(btnEliminar);

            //Editar
            const btnEditar = document.createElement('button');
            btnEditar.textContent = '✎';
            btnEditar.className = 'btn-editar'

            btnEditar.onclick = function () {
                if (modoEdicion && paqueteEnEdicion && paqueteEnEdicion.id !== paquete.id) {
                    alert('Modo Edición: Ya estas editando otro paquete. Guarda los cambios');
                    return;   
                }
                EnModoEdición(paquete);                
            };
            card.append(btnEditar);

            // Dibujar la caja en el div correspondiente
            const canvas = draw(paquete.largo, paquete.ancho, paquete.alto, paquete.color);
            dibujo.append(canvas);

            // Añadir la tarjeta al listado 
            listadoPaquetes.appendChild(card);
        
        

    });
}


        // Manejo del formulario de repartidor
        formRepartidor.addEventListener('submit', function (event) {
            event.preventDefault();

            if (modoEdicion) {
                alert('Modo Edición: Guarda primero los cambios')
                return;
                
            }

            const nombre = document.getElementById('nombreRepartidor').value.trim();
            const vehiculo = document.getElementById('vehiculoRepartidor').value.trim();
            const experiencia = parseInt(document.getElementById('experienciaRepartidor').value);

            if (!nombre || !vehiculo ||experiencia < 0) {
                alert('Por favor, complete todos los campos del repartidor.');
                return;
            }
            // Crear nuevo repartidor y añadirlo al array
            const nuevoRepartidor = new Repartidor(nombre, vehiculo, experiencia);
            repartidores.push(nuevoRepartidor);

            actualizarSelectRepartidores();
            formRepartidor.reset();
            guardarDatos();
            
        });

        // Manejo del formulario de paquete
        formPaquete.addEventListener('submit', function (event) {
        event.preventDefault();
            // Obtener valores del formulario
        const peso = parseFloat(document.getElementById('pesoPaquete').value);
        const largo = parseInt(document.getElementById('largoPaquete').value);
        const ancho = parseInt(document.getElementById('anchoPaquete').value);
        const alto   = parseInt(document.getElementById('altoPaquete').value);
        const destino = document.getElementById('destinoPaquete').value;
        const color = document.getElementById('colorPaquete').value;
        // Obtener el índice del repartidor seleccionado
        const indiceRepartidor = selectRepartidor.value;

        // Validación de campos
        if (!peso || !largo || !ancho ||!alto || !destino || !color || indiceRepartidor === "") {
            alert("Por favor, complete todos los campos del paquete.");
            return;
        }
        // Crear nuevo paquete
        const repartidorSeleccionado = repartidores[indiceRepartidor];
        //Si estamos en modo edición
        if (modoEdicion && paqueteEnEdicion) {
            paqueteEnEdicion.peso       = peso;
            paqueteEnEdicion.largo      = largo;
            paqueteEnEdicion.ancho      = ancho;
            paqueteEnEdicion.alto       = alto;
            paqueteEnEdicion.destino    = destino;
            paqueteEnEdicion.color      = color ;
            paqueteEnEdicion.repartidor = repartidorSeleccionado;
        
            pintarPaquetes();
            formPaquete.reset();
            selectRepartidor.selectedIndex = 0;
            salirModoEdicion();
            alert('Paquete actualizado correctamente');
            return;   
        }

        //si no estamos en modo edición
        const nuevoIdPaquete = Reparto.paquetes.length + 1;

        const nuevoPaquete = new Paquete(
            nuevoIdPaquete,
            peso,
            largo,
            ancho,
            alto,
            destino,
            color,
            repartidorSeleccionado
        );
        // Agregar paquete al objeto Reparto
        Reparto.agregarPaquete(nuevoPaquete);
        // Actualizar la visualización de paquetes
        pintarPaquetes();
        formPaquete.reset();
        // Reiniciar el select de repartidores
        selectRepartidor.selectedIndex = 0;
        guardarDatos();
        
    });


    // Función para dibujar el paquete en un canvas
    function draw(largo, ancho, alto, color) {
    const canvas = document.createElement("canvas");
    canvas.width = 200;
    canvas.height = 200;
    const ctx = canvas.getContext("2d");
    let grosor = 2;

    // --- Escalado automático si las medidas son grandes ---
    const maxMedida = Math.max(largo, ancho, alto);
    const maxPermitido = 150;      // tamaño máximo dibujable
    const factor = maxMedida > maxPermitido ? maxPermitido / maxMedida : 1;

    largo *= factor;
    ancho *= factor;
    alto  *= factor;
    grosor *= factor;

    // Profundidad (igual que antes)
    const d = largo / 3;

    // --- Cálculo del tamaño del dibujo final ---
    const dibujoWidth  = ancho + d;
    const dibujoHeight = alto + d;

    // --- Centramos el dibujo ---
    const offsetX = (canvas.width  - dibujoWidth)  / 2;
    const offsetY = (canvas.height - dibujoHeight) / 2;
    ctx.translate(offsetX, offsetY);

    // Estilo
    ctx.fillStyle = color;
    ctx.globalAlpha = 0.6;

    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(d, d);
    ctx.lineTo(ancho + d, d);
    ctx.lineTo(ancho, 0);
    ctx.lineTo(0, 0);

    ctx.lineTo(0, alto);
    ctx.lineTo(d, alto + d);
    ctx.lineTo(ancho + d, alto + d);
    ctx.lineTo(ancho + d, d);

    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.fill();

    // Cara trasera
    ctx.fillRect(0, 0, ancho, alto);

    // Cara frontal desplazada
    ctx.translate(d, d);
    ctx.fillRect(0, 0, ancho, alto);

    canvas.style.width = '100%';
    canvas.style.height = 'auto';

    return canvas;
}

    
    // Inicio
    actualizarSelectRepartidores();
    pintarPaquetes();
    
    </script>
    </body>
</html>